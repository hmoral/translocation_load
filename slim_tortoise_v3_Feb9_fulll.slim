initialize() {
	
	if (exists("DIR_in")==0){
		defineConstant("DIR","/Users/nrv690/Desktop/slim_out");
	}
	else{
		defineConstant("DIR",DIR_in);
	}
	
	
	if (exists("chrL_in")==0){
		defineConstant("chrL",1e6);
	}
	else{
		defineConstant("chrL",chrL_in);
	}
	
	if (exists("nMetaPop_in")==0){
		defineConstant("nMetaPop",4);
	}
	else{
		defineConstant("nMetaPop",nMetaPop_in);
	}
	
	if (exists("distrMeta_in")==0){
		defineConstant("distrMeta","var");
	}
	else{
		defineConstant("distrMeta",distrMeta_in);
	}
	
	if(distrMeta=="fix"){
		defineConstant("N_metaPop",rep(500,nMetaPop));
	}
	
	if(distrMeta=="var" & nMetaPop==4){
		defineConstant("N_metaPop",c(50, 100, 500, 1000));
	}
	
	if(distrMeta=="var" & nMetaPop==6){
		defineConstant("N_metaPop",c(50,80,150,400,500,1000));
	}
	
	defineConstant("N_trans",250);
	
	if (exists("trans_mode_in")==0){
		defineConstant("trans_mode",9);
	}
	else{
		defineConstant("trans_mode",trans_mode_in);
	}
	
	
	if (exists("s_distr_in")==0){
		defineConstant("s_distr","unif");
	}
	else{
		defineConstant("s_distr",s_distr_in);
	}
	
	
	defineConstant("prefix","chr"+chrL+"_K"+nMetaPop+"_"+distrMeta+"Tdist"+"_Tmode"+trans_mode+"_"+s_distr+"Sdist");
	
	initializeSLiMModelType("nonWF");
	initializeSLiMOptions(keepPedigrees=T);
	initializeMutationRate(1e-7);
	initializeMutationType("m1", 0.5, "f", 0.0);         // non-coding
	
	if(s_distr=="fix"){initializeMutationType("m2", 0.01, "f", -0.01);}
	
	if(s_distr=="unif"){
		del_unif = "runif(1,-0.5,-0.001);";
		initializeMutationType("m2", 0.01, "s", del_unif);
	}
	
	if(s_distr=="custom"){
		del_custom="sample(c(rep(-0.001,400),rep(-0.01,300),rep(-0.05,200),rep(-0.1,80),rep(-0.25,20)),1);";
		initializeMutationType("m2", 0.01, "s", del_custom);
	}
	
	
	m1.convertToSubstitution=T;
	m2.convertToSubstitution=F;
	
	initializeGenomicElementType("g1", c(m1,m2), c(0.8,0.2));
	initializeGenomicElement(g1, 0, chrL);
	initializeRecombinationRate(1e-8);
	system("mkdir -p "+ DIR);
	defineConstant("seed",getSeed());
}

1 {
	for (i in 1:nMetaPop){
		pop="p"+i;
		Ne=N_metaPop[i-1];
		sim.addSubpop(pop, Ne);
		sim.subpopulations[i-1].tag=Ne;
		print("gen "+sim.generation);
		print("N = "+sapply(sim.subpopulations, "mean(applyValue.individualCount);"));
		print("m2 count= "+sapply(sim.subpopulations, "mean(applyValue.individuals.countOfMutationsOfType(m2));"));
		print("m2 loci= "+sapply(sim.subpopulations, "length(unique(applyValue.individuals.uniqueMutationsOfType(m2).position));"));
		print("m2 freq= "+sapply(sim.subpopulations, "mean(sim.mutationFrequencies(applyValue,applyValue.individuals.uniqueMutationsOfType(m2)));"));
		print("m2 mig= "+sapply(sim.subpopulations, "length(unique(applyValue.individuals.migrant));"));
	}
	
	//	out="gen" + "\t" + "time" + "\t" + "ID"+ "\t" + "fit" + "\t" + "pi" + "\t" + "indvLoad" + "\t" + "freq" + "\t" + "HomAlt" + "\t" + "Het";
	out="gen" + "\t" + "pop" + "\t" + "ID"+ "\t" + "fit" + "\t" + "pi" + "\t" + "indvLoad"+ "\t" + "indvLoadHom"+ "\t" + "indvLoadHet"+ "\t" + "mCount"+ "\t" + "meanFreq"+ "\t" + "time";
	
	writeFile((DIR+"/slim_out_metrics_"+seed+"_"+prefix+".txt"),out,append=F);
	
	
	out="gen" + "\t" + "id" + "\t" + "pop"+ "\t" + "pedGrndP" + "\t" + "pedParents" + "\t" + "pedIndv";
	writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=F);


}

reproduction() {
	for (pop in sim.subpopulations){
		K=pop.tag;
		for (i in seqLen(K))
		{
			firstParent = pop.sampleIndividuals(1);
			secondParent = pop.sampleIndividuals(1);
			pop.addCrossed(firstParent, secondParent);
		}
	}
	self.active = 0;
}

early()
{
	inds = sim.subpopulations.individuals;
	inds[inds.age > 0].fitnessScaling = 0.0;
}


4999 late() {
	pop=length(sim.subpopulations)+1;
	pop="p"+pop;
	sim.addSubpop(pop, 0);
	if(trans_mode==1){
		migrants=c();
		for (pop in 1:nMetaPop){
			migrants=c(migrants,sim.subpopulations[pop-1].individuals[sim.subpopulations[pop-1].individuals.age==0]);
		}
		migrants=sample(migrants,N_trans,weights=(5-migrants.subpopulation.id));
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		
		
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	
	}
	
	if(trans_mode==2){
		Q=0.8;
		ALL_indv=sim.subpopulations.individuals[sim.subpopulations.individuals.age==0];
		ALL_indv_pi=c();
		ALL_indv_load=c();
		for(indv in ALL_indv){
			// Calculate the nucleotide heterozygosity of this individual
			muts0 = indv.genomes[0].mutations;
			muts1 = indv.genomes[1].mutations;
			
			// Count the shared mutations
			shared_count = sum(match(muts0, muts1) >= 0);
			
			// All remaining mutations in the genomes are unshared (i.e. heterozygous)
			unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
			
			// pi is the mean heterozygosity across the chromosome
			pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
			ALL_indv_pi=c(ALL_indv_pi,pi_ind);
			
			muts0_m2=indv.genomes[0].mutationsOfType(m2);
			muts1_m2=indv.genomes[1].mutationsOfType(m2);
			
			if(length(muts0_m2)+length(muts1_m2)>0){
				HOMO_m2=setIntersection(muts0_m2,muts1_m2);
				HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
				IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
				IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
				IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
				fit=1-IndvLoadM2;
			} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
			ALL_indv_load=c(ALL_indv_load,IndvLoadM2);
		}
		ALL_indv_pi_sorted=sort(ALL_indv_pi);
		piTresh=ALL_indv_pi_sorted[round((length(ALL_indv_pi_sorted)-1)*Q + 1)-1];
		migrants=sample(ALL_indv[ALL_indv_pi>=piTresh],N_trans);
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}
	
	if(trans_mode==3){
		Q=0.2;
		ALL_indv=sim.subpopulations.individuals[sim.subpopulations.individuals.age==0];
		ALL_indv_pi=c();
		ALL_indv_load=c();
		for(indv in ALL_indv){
			// Calculate the nucleotide heterozygosity of this individual
			muts0 = indv.genomes[0].mutations;
			muts1 = indv.genomes[1].mutations;
			
			// Count the shared mutations
			shared_count = sum(match(muts0, muts1) >= 0);
			
			// All remaining mutations in the genomes are unshared (i.e. heterozygous)
			unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
			
			// pi is the mean heterozygosity across the chromosome
			pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
			ALL_indv_pi=c(ALL_indv_pi,pi_ind);
			
			muts0_m2=indv.genomes[0].mutationsOfType(m2);
			muts1_m2=indv.genomes[1].mutationsOfType(m2);
			
			if(length(muts0_m2)+length(muts1_m2)>0){
				HOMO_m2=setIntersection(muts0_m2,muts1_m2);
				HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
				IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
				IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
				IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
				fit=1-IndvLoadM2;
			} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
			ALL_indv_load=c(ALL_indv_load,IndvLoadM2);
		}
		ALL_indv_load_sorted=sort(ALL_indv_load);
		loadTresh=ALL_indv_load_sorted[round((length(ALL_indv_load_sorted)-1)*Q + 1)-1];
		migrants=sample(ALL_indv[ALL_indv_load<=loadTresh],N_trans);
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}
	
	if(trans_mode==4){
		Q=0.2;
		ALL_indv=sim.subpopulations.individuals[sim.subpopulations.individuals.age==0];
		ALL_indv_m2Count=c();
		for(indv in ALL_indv){
			m2Count=indv.countOfMutationsOfType(m2);
			ALL_indv_m2Count=c(ALL_indv_m2Count,m2Count);
		}
		ALL_indv_m2Count_sorted=sort(ALL_indv_m2Count);
		loadTresh=ALL_indv_m2Count_sorted[round((length(ALL_indv_m2Count_sorted)-1)*Q + 1)-1];
		migrants=sample(ALL_indv[ALL_indv_m2Count<=loadTresh],N_trans);
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}
	
	if(trans_mode==5){
		Q=0.8;
		migrants=c();
		for (pop in 1:nMetaPop){
			ALL_indv=sim.subpopulations[pop-1].individuals[sim.subpopulations[pop-1].individuals.age==0];
			ALL_indv_pi=c();
			ALL_indv_load=c();
			for(indv in ALL_indv){
				// Calculate the nucleotide heterozygosity of this individual
				muts0 = indv.genomes[0].mutations;
				muts1 = indv.genomes[1].mutations;
				
				// Count the shared mutations
				shared_count = sum(match(muts0, muts1) >= 0);
				
				// All remaining mutations in the genomes are unshared (i.e. heterozygous)
				unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
				
				// pi is the mean heterozygosity across the chromosome
				pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
				ALL_indv_pi=c(ALL_indv_pi,pi_ind);
				
				muts0_m2=indv.genomes[0].mutationsOfType(m2);
				muts1_m2=indv.genomes[1].mutationsOfType(m2);
				
				if(length(muts0_m2)+length(muts1_m2)>0){
					HOMO_m2=setIntersection(muts0_m2,muts1_m2);
					HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
					IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
					IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
					IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
					fit=1-IndvLoadM2;
				} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
				ALL_indv_load=c(ALL_indv_load,IndvLoadM2);
			}
			ALL_indv_pi_sorted=sort(ALL_indv_pi);
			piTresh=ALL_indv_pi_sorted[round((length(ALL_indv_pi_sorted)-1)*Q + 1)-1];
			migrants_pop=ALL_indv[ALL_indv_pi>=piTresh];
			migrants=c(migrants,migrants_pop);
		}
		migrants=sample(migrants,N_trans,weights=(5-migrants.subpopulation.id));
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}
	
	if(trans_mode==6){
		Q=0.2;
		migrants=c();
		for (pop in 1:nMetaPop){
			ALL_indv=sim.subpopulations[pop-1].individuals[sim.subpopulations[pop-1].individuals.age==0];
			ALL_indv_pi=c();
			ALL_indv_load=c();
			for(indv in ALL_indv){
				// Calculate the nucleotide heterozygosity of this individual
				muts0 = indv.genomes[0].mutations;
				muts1 = indv.genomes[1].mutations;
				
				// Count the shared mutations
				shared_count = sum(match(muts0, muts1) >= 0);
				
				// All remaining mutations in the genomes are unshared (i.e. heterozygous)
				unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
				
				// pi is the mean heterozygosity across the chromosome
				pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
				ALL_indv_pi=c(ALL_indv_pi,pi_ind);
				
				muts0_m2=indv.genomes[0].mutationsOfType(m2);
				muts1_m2=indv.genomes[1].mutationsOfType(m2);
				
				if(length(muts0_m2)+length(muts1_m2)>0){
					HOMO_m2=setIntersection(muts0_m2,muts1_m2);
					HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
					IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
					IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
					IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
					fit=1-IndvLoadM2;
				} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
				ALL_indv_load=c(ALL_indv_load,IndvLoadM2);
			}
			ALL_indv_load_sorted=sort(ALL_indv_load);
			loadTresh=ALL_indv_load_sorted[round((length(ALL_indv_load_sorted)-1)*Q + 1)-1];
			migrants_pop=ALL_indv[ALL_indv_load<=loadTresh];
			migrants=c(migrants,migrants_pop);
		}
		migrants=sample(migrants,N_trans,weights=(5-migrants.subpopulation.id));
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}
	
	if(trans_mode==7){
		Q=0.2;
		migrants=c();
		for (pop in 1:nMetaPop){
			ALL_indv=sim.subpopulations[pop-1].individuals[sim.subpopulations[pop-1].individuals.age==0];
			ALL_indv_m2Count=c();
			for(indv in ALL_indv){
				m2Count=indv.countOfMutationsOfType(m2);
				ALL_indv_m2Count=c(ALL_indv_m2Count,m2Count);
			}
			ALL_indv_m2Count_sorted=sort(ALL_indv_m2Count);
			loadTresh=ALL_indv_m2Count_sorted[round((length(ALL_indv_m2Count_sorted)-1)*Q + 1)-1];
			migrants=sample(ALL_indv[ALL_indv_m2Count<=loadTresh],N_trans);
			migrants=c(migrants,migrants_pop);
		}
		migrants=sample(migrants,N_trans,weights=(5-migrants.subpopulation.id));
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}
	
	if(trans_mode==8){
		Q=0.5;
		migrants=c();
		for (pop in 1:nMetaPop){
			ALL_indv=sim.subpopulations[pop-1].individuals[sim.subpopulations[pop-1].individuals.age==0];
			ALL_indv_pi=c();
			ALL_indv_load=c();
			for(indv in ALL_indv){
				// Calculate the nucleotide heterozygosity of this individual
				muts0 = indv.genomes[0].mutations;
				muts1 = indv.genomes[1].mutations;
				
				// Count the shared mutations
				shared_count = sum(match(muts0, muts1) >= 0);
				
				// All remaining mutations in the genomes are unshared (i.e. heterozygous)
				unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
				
				// pi is the mean heterozygosity across the chromosome
				pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
				ALL_indv_pi=c(ALL_indv_pi,pi_ind);
				
				muts0_m2=indv.genomes[0].mutationsOfType(m2);
				muts1_m2=indv.genomes[1].mutationsOfType(m2);
				
				if(length(muts0_m2)+length(muts1_m2)>0){
					HOMO_m2=setIntersection(muts0_m2,muts1_m2);
					HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
					IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
					IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
					IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
					fit=1-IndvLoadM2;
				} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
				ALL_indv_load=c(ALL_indv_load,IndvLoadM2);
			}
			ALL_indv_load_sorted=sort(ALL_indv_load);
			loadTresh=ALL_indv_load_sorted[round((length(ALL_indv_load_sorted)-1)*Q + 1)-1];
			migrants=ALL_indv[ALL_indv_load<=loadTresh];
		}
		migrants_Ux=c();
		for(indv in migrants){
			pop=indv.subpopulation.id;
			Ux=sum(1-sim.mutationFrequencies(sim.subpopulations[pop-1],indv.uniqueMutations));
			indv.setValue("Ux",Ux);
			migrants_Ux=c(migrants_Ux,Ux);
		}
		Ux_sort=sort(migrants.getValue("Ux"),ascending=F);
		Ux_sort=Ux_sort[0:(N_trans-1)];Ux_tresh=Ux_sort[length(Ux_sort)-1];
		migrants=migrants[migrants.getValue("Ux")>=Ux_tresh];
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}
	
	
	if(trans_mode==9){
		Q=0.5;
		migrants=c();
		for (pop in 1:nMetaPop){
			ALL_indv=sim.subpopulations[pop-1].individuals[sim.subpopulations[pop-1].individuals.age==0];
			ALL_indv_pi=c();
			ALL_indv_load=c();
			for(indv in ALL_indv){
				// Calculate the nucleotide heterozygosity of this individual
				muts0 = indv.genomes[0].mutations;
				muts1 = indv.genomes[1].mutations;
				
				// Count the shared mutations
				shared_count = sum(match(muts0, muts1) >= 0);
				
				// All remaining mutations in the genomes are unshared (i.e. heterozygous)
				unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
				
				// pi is the mean heterozygosity across the chromosome
				pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
				ALL_indv_pi=c(ALL_indv_pi,pi_ind);
				
				muts0_m2=indv.genomes[0].mutationsOfType(m2);
				muts1_m2=indv.genomes[1].mutationsOfType(m2);
				
				if(length(muts0_m2)+length(muts1_m2)>0){
					HOMO_m2=setIntersection(muts0_m2,muts1_m2);
					HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
					IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
					IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
					IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
					fit=1-IndvLoadM2;
				} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
				ALL_indv_load=c(ALL_indv_load,IndvLoadM2);
			}
			ALL_indv_load_sorted=sort(ALL_indv_load);
			loadTresh=ALL_indv_load_sorted[round((length(ALL_indv_load_sorted)-1)*Q + 1)-1];
			migrants=ALL_indv[ALL_indv_load<=loadTresh];
		}
		migrants_Ux=c();
		for(indv in migrants){
			pop=indv.subpopulation.id;
			Ux=sum(1-sim.mutationFrequencies(sim.subpopulations[pop-1],indv.uniqueMutationsOfType(m1)));
			indv.setValue("Ux",Ux);
			migrants_Ux=c(migrants_Ux,Ux);
		}
		Ux_sort=sort(migrants.getValue("Ux"),ascending=F);
		Ux_sort=Ux_sort[0:(N_trans-1)];Ux_tresh=Ux_sort[length(Ux_sort)-1];
		migrants=migrants[migrants.getValue("Ux")>=Ux_tresh];
		print("/n"+"###########################");
		print("Migrants from pops");
		print(length(migrants));
		print(unique(migrants.subpopulation.id));
		print(length(unique(migrants.pedigreeGrandparentIDs)));print(length(unique(migrants.pedigreeParentIDs)));
		print(length(unique(migrants.pedigreeID)));		print("###########################"+"\n");
		//		print("migrants from p" + 1:nMetaPop + " " + sapply(sim.subpopulations.id, "sum(applyValue==migrants.subpopulation.id);"));
		mig_id=migrants.index;
		mig_pop=migrants.subpopulation.id;
		mig_pedGrndP=length(unique(migrants.pedigreeGrandparentIDs));
		mig_pedParents=length(unique(migrants.pedigreeParentIDs));
		mig_pedIndv=length(unique(migrants.pedigreeID));
		out=sim.generation + "\t" + mig_id + "\t" + mig_pop + "\t" + mig_pedGrndP + "\t" + mig_pedParents + "\t" + mig_pedIndv;
		writeFile((DIR+"/slim_out_translocation_"+seed+"_"+prefix+".txt"),out,append=T);
		sim.subpopulations[nMetaPop].takeMigrants(migrants);
		sim.subpopulations[nMetaPop].tag=N_trans;
		sim.subpopulations[0:(nMetaPop-1)].removeSubpopulation();
	}

}

4990: early() { if(sim.generation % 1 == 0){
		print("gen "+sim.generation);
		print("N = "+sapply(sim.subpopulations, "mean(applyValue.individualCount);"));
		print("m2 count= "+sapply(sim.subpopulations, "mean(applyValue.individuals.countOfMutationsOfType(m2));"));
		print("m2 loci= "+sapply(sim.subpopulations, "length(unique(applyValue.individuals.uniqueMutationsOfType(m2).position));"));
		print("m2 freq= "+sapply(sim.subpopulations, "mean(sim.mutationFrequencies(applyValue,applyValue.individuals.uniqueMutationsOfType(m2)));"));
		print("m2 mig= "+sapply(sim.subpopulations, "length(unique(applyValue.individuals.migrant));"));
	}

}

5000: early() {
	ALL_indv=sim.subpopulations.individuals;
	for(indv in ALL_indv){
		ID=indv.pedigreeID;
		POP=indv.subpopulation.id;
		mut=indv.uniqueMutationsOfType(m2);
		mutCount=length(mut);
		freq=mean(sim.mutationFrequencies(p5,mut));
		
		// Calculate the nucleotide heterozygosity of this individual
		muts0 = indv.genomes[0].mutations;
		muts1 = indv.genomes[1].mutations;
		
		// Count the shared mutations
		shared_count = sum(match(muts0, muts1) >= 0);
		
		// All remaining mutations in the genomes are unshared (i.e. heterozygous)
		unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
		
		// pi is the mean heterozygosity across the chromosome
		pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
		
		muts0_m2=indv.genomes[0].mutationsOfType(m2);
		muts1_m2=indv.genomes[1].mutationsOfType(m2);
		
		if(length(muts0_m2)+length(muts1_m2)>0){
			HOMO_m2=setIntersection(muts0_m2,muts1_m2);
			HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
			IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
			IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
			IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
			fit=1-IndvLoadM2;
		} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
		
		
		//		out=sim.generation + "\t" + "late" + "\t" + ID + "\t" + fit + "\t" + pi_ind + "\t" + IndvLoadM2  + "\t" + freq + "\t" + HomAlt + "\t" + Het;
		out=sim.generation + "\t" + POP + "\t" + ID + "\t" + fit + "\t" + pi_ind + "\t" + IndvLoadM2+ "\t" + IndvLoadM2_homo+ "\t" + IndvLoadM2_hetero + "\t" + mutCount+ "\t" + freq+ "\t" + "early";
		
		writeFile((DIR+"/slim_out_metrics_"+seed+"_"+prefix+".txt"),out,append=T);
	
	}
}


4999: late() {
	ALL_indv=sim.subpopulations.individuals;
	for(indv in ALL_indv){
		ID=indv.pedigreeID;
		POP=indv.subpopulation.id;
		mut=indv.uniqueMutationsOfType(m2);
		mutCount=length(mut);
		freq=mean(sim.mutationFrequencies(p5,mut));
		
		// Calculate the nucleotide heterozygosity of this individual
		muts0 = indv.genomes[0].mutations;
		muts1 = indv.genomes[1].mutations;
		
		// Count the shared mutations
		shared_count = sum(match(muts0, muts1) >= 0);
		
		// All remaining mutations in the genomes are unshared (i.e. heterozygous)
		unshared_count = muts0.size() + muts1.size() - 2 * shared_count;
		
		// pi is the mean heterozygosity across the chromosome
		pi_ind = unshared_count / (sim.chromosome.lastPosition + 1);
		
		muts0_m2=indv.genomes[0].mutationsOfType(m2);
		muts1_m2=indv.genomes[1].mutationsOfType(m2);
		
		if(length(muts0_m2)+length(muts1_m2)>0){
			HOMO_m2=setIntersection(muts0_m2,muts1_m2);
			HETERO_m2=setSymmetricDifference(muts0_m2,muts1_m2);
			IndvLoadM2_homo=abs(sum(HOMO_m2.selectionCoeff));
			IndvLoadM2_hetero=abs(sum(HETERO_m2.selectionCoeff*m2.dominanceCoeff));
			IndvLoadM2=abs(IndvLoadM2_homo+IndvLoadM2_hetero);
			fit=1-IndvLoadM2;
		} else { IndvLoadM2_homo=0;IndvLoadM2_hetero=0;IndvLoadM2=0;fit=1-IndvLoadM2;}
		
		
		//		out=sim.generation + "\t" + "late" + "\t" + ID + "\t" + fit + "\t" + pi_ind + "\t" + IndvLoadM2  + "\t" + freq + "\t" + HomAlt + "\t" + Het;
		out=sim.generation + "\t" + POP + "\t" + ID + "\t" + fit + "\t" + pi_ind + "\t" + IndvLoadM2+ "\t" + IndvLoadM2_homo+ "\t" + IndvLoadM2_hetero + "\t" + mutCount+ "\t" + freq+ "\t" + "late";
		
		writeFile((DIR+"/slim_out_metrics_"+seed+"_"+prefix+".txt"),out,append=T);
	
	}
}


5010 { sim.simulationFinished(); }